#include <SPI.h>
#include <LoRa.h>
#include <WiFi.h>
#include <HTTPClient.h>

/* -------- LoRa Pins -------- */
#define LORA_SCK   13
#define LORA_MISO  12
#define LORA_MOSI  27
#define LORA_SS    26
#define LORA_RST   25
#define LORA_DIO0  33

#define LORA_FREQ 433E6

/* -------- WIFI SETTINGS -------- */
const char* ssid = "HardwareHackathon203";
const char* password = "hardware";

/* -------- SERVER -------- */
const char* serverUrl = "http://192.168.10.225:8080/weather-data";

String incomingData = "";

void setup() {
  Serial.begin(115200);
  delay(2000);
  Serial.println("\n=== ESP32 LORA FINAL STATION START ===");

  /* ---- WIFI INIT ---- */
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ WiFi connected");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());

  /* ---- LORA INIT ---- */
  SPI.begin(LORA_SCK, LORA_MISO, LORA_MOSI, LORA_SS);
  LoRa.setPins(LORA_SS, LORA_RST, LORA_DIO0);

  if (!LoRa.begin(LORA_FREQ)) {
    Serial.println("‚ùå LoRa init failed!");
    while (1);
  }

  Serial.println("‚úÖ LoRa Ready (Final Station)");
}

void loop() {
  int packetSize = LoRa.parsePacket();
  if (!packetSize) return;

  /* -------- READ LORA -------- */
  incomingData = "";
  while (LoRa.available()) {
    incomingData += (char)LoRa.read();
  }
  incomingData.trim();

  Serial.print("üì• Received: ");
  Serial.println(incomingData);

  /* -------- PARSE CSV -------- */
  int c1 = incomingData.indexOf(',');
  int c2 = incomingData.indexOf(',', c1 + 1);
  int c3 = incomingData.indexOf(',', c2 + 1);

  if (c1 == -1 || c2 == -1 || c3 == -1) {
    Serial.println("‚ùå Invalid packet format");
    return;
  }

  float temp = incomingData.substring(0, c1).toFloat();
  float pressure = incomingData.substring(c1 + 1, c2).toFloat() / 100.0; // Pa ‚Üí hPa
  float humidity = incomingData.substring(c2 + 1, c3).toFloat();

  String rainStr = incomingData.substring(c3 + 1);
  rainStr.trim();
  bool isRain = (rainStr == "1");   // TRUE rain fix

  /* -------- DEBUG -------- */
  Serial.print("üåß Rain raw: [");
  Serial.print(rainStr);
  Serial.print("]  ‚Üí bool: ");
  Serial.println(isRain);

  /* -------- VALIDATION -------- */
  if (temp < -50 || temp > 60) temp = 0;
  if (humidity < 0 || humidity > 100) humidity = 0;
  if (pressure < 800 || pressure > 1200) pressure = 1013;

  /* -------- JSON PAYLOAD (BOOLEAN FIXED) -------- */
  String jsonPayload = "{";
  jsonPayload += "\"temp\":" + String(temp, 1) + ",";
  jsonPayload += "\"humidity\":" + String(humidity, 1) + ",";
  jsonPayload += "\"pressure\":" + String(pressure, 1) + ",";
  jsonPayload += "\"uv\":0,";
  jsonPayload += "\"isRain\":";
  jsonPayload += (isRain ? "true" : "false");
  jsonPayload += "}";

  Serial.print("üåê Sending JSON: ");
  Serial.println(jsonPayload);

  /* -------- HTTP POST -------- */
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(serverUrl);
    http.addHeader("Content-Type", "application/json");

    int httpCode = http.POST(jsonPayload);
    if (httpCode > 0) {
      Serial.print("‚úÖ POST Response: ");
      Serial.println(httpCode);
    } else {
      Serial.print("‚ùå POST Error: ");
      Serial.println(http.errorToString(httpCode));
    }
    http.end();
  } else {
    Serial.println("‚ùå WiFi disconnected!");
  }

  delay(200);
}
