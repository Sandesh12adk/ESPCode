#include <Wire.h>
#include <Adafruit_BMP085.h>
#include <DHT.h>
#include <SPI.h>
#include <LoRa.h>

/* -------- PIN DEFINITIONS -------- */
#define BMP_SDA 25
#define BMP_SCL 26
#define DHTPIN  14
#define RAINPIN 32  // Rain sensor D0

/* -------- SENSOR TYPE -------- */
#define DHTTYPE DHT11

/* -------- LoRa PINS -------- */
#define LORA_SCK  18
#define LORA_MISO 19
#define LORA_MOSI 23
#define LORA_SS   5
#define LORA_RST  27
#define LORA_DIO0 33

/* -------- OBJECTS -------- */
Adafruit_BMP085 bmp;
DHT dht(DHTPIN, DHTTYPE);

void setup() {
  Serial.begin(115200);
  delay(2000);
  Serial.println("\n=== ESP32 SENSOR + LORA START ===");

  // ---- I2C INIT ----
  Wire.begin(BMP_SDA, BMP_SCL);

  // ---- BMP180 INIT ----
  if (!bmp.begin()) Serial.println("‚ùå BMP180 NOT FOUND");
  else Serial.println("‚úÖ BMP180 OK");

  // ---- DHT INIT ----
  dht.begin();
  Serial.println("‚úÖ DHT OK");

  // ---- Rain Sensor INIT ----
  pinMode(RAINPIN, INPUT);
  Serial.println("‚úÖ Rain sensor OK");

  // ---- LORA INIT ----
  SPI.begin(LORA_SCK, LORA_MISO, LORA_MOSI, LORA_SS);
  LoRa.setPins(LORA_SS, LORA_RST, LORA_DIO0);

  if (!LoRa.begin(433E6)) {
    Serial.println("‚ùå LoRa init failed!");
    while (1);
  }
  Serial.println("‚úÖ LoRa Ready");
}

void loop() {
  float bmpTemp = bmp.readTemperature();
  float bmpPressure = bmp.readPressure(); // Pa
  float humidity = dht.readHumidity();
  bool isRain = digitalRead(RAINPIN);   // true/false

  // Replace NaN with 0
  if (isnan(bmpTemp)) bmpTemp = 0;
  if (isnan(bmpPressure)) bmpPressure = 0;
  if (isnan(humidity)) humidity = 0;

  // Print to Serial
  Serial.println("---- SENSOR DATA ----");
  Serial.print("BMP Temp: "); Serial.println(bmpTemp);
  Serial.print("Pressure: "); Serial.println(bmpPressure);
  Serial.print("Humidity: "); Serial.println(humidity);
  Serial.print("Rain: "); Serial.println(isRain ? "No" : "Yes");
  Serial.println("---------------------");

  // Create LoRa packet: temp,pressure,humidity,rain
  String data = String(bmpTemp) + "," + String(bmpPressure) + "," + String(humidity) + "," + (isRain ? "1" : "0");

  // Send LoRa
  LoRa.beginPacket();
  LoRa.print(data);
  int result = LoRa.endPacket();

  if (result == 1) Serial.println("üì° LoRa data sent successfully: " + data);
  else Serial.println("‚ùå LoRa data send failed!");

  delay(2000);
}
