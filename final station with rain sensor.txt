#include <SPI.h> 
#include <LoRa.h>
#include <WiFi.h>
#include <HTTPClient.h>

/* -------- LoRa Pins -------- */
#define LORA_SCK  13
#define LORA_MISO 12
#define LORA_MOSI 27
#define LORA_SS   26
#define LORA_RST  25
#define LORA_DIO0 33

#define LORA_FREQ 433E6

/* -------- WIFI SETTINGS -------- */
const char* ssid = "HardwareHackathon203";
const char* password = "hardware";

String incomingData = "";

void setup() {
  Serial.begin(115200);
  delay(2000);
  Serial.println("\n=== ESP32 LORA FINAL STATION START ===");

  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ Connected to WiFi");
  Serial.print("ESP32 IP: ");
  Serial.println(WiFi.localIP());

  SPI.begin(LORA_SCK, LORA_MISO, LORA_MOSI, LORA_SS);
  LoRa.setPins(LORA_SS, LORA_RST, LORA_DIO0);

  if (!LoRa.begin(LORA_FREQ)) {
    Serial.println("‚ùå LoRa init failed!");
    while (1);
  }
  Serial.println("‚úÖ LoRa Ready (Final Station)");
}

void loop() {
  int packetSize = LoRa.parsePacket();
  if (packetSize) {
    incomingData = "";
    while (LoRa.available()) incomingData += (char)LoRa.read();
    incomingData.trim();
    Serial.print("üì• Received: ");
    Serial.println(incomingData);

    // Parse CSV: temp,pressure,humidity,rain
    float temp = 0, pressure = 0, humidity = 0;
    bool isRain = false;

    int firstComma = incomingData.indexOf(',');
    int secondComma = incomingData.indexOf(',', firstComma + 1);
    int thirdComma = incomingData.indexOf(',', secondComma + 1);

    if (firstComma != -1 && secondComma != -1 && thirdComma != -1) {
      temp = incomingData.substring(0, firstComma).toFloat();
      pressure = incomingData.substring(firstComma + 1, secondComma).toFloat() / 100.0; // Pa ‚Üí hPa
      humidity = incomingData.substring(secondComma + 1, thirdComma).toFloat();
      isRain = incomingData.substring(thirdComma + 1).toInt() == 1;

      // Validate
      if (temp < -50 || temp > 60) temp = 0;
      if (humidity < 0 || humidity > 100) humidity = 0;
      if (pressure < 800 || pressure > 1200) pressure = 1013;
    } else {
      Serial.println("‚ùå Invalid LoRa data format!");
      return;
    }

    // Build JSON
    String jsonPayload = "{";
    jsonPayload += "\"temp\":" + String(temp, 1) + ",";
    jsonPayload += "\"humidity\":" + String(humidity, 1) + ",";
    jsonPayload += "\"pressure\":" + String(pressure, 1) + ",";
    jsonPayload += "\"uv\":0,";
    jsonPayload += "\"isRain\":" + String(isRain ? "true" : "false");
    jsonPayload += "}";

    Serial.print("üåê Sending JSON: ");
    Serial.println(jsonPayload);

    // POST
    if (WiFi.status() == WL_CONNECTED) {
      HTTPClient http;
      http.begin("http://192.168.10.225:8080/weather-data");
      http.addHeader("Content-Type", "application/json");
      int code = http.POST(jsonPayload);
      if (code > 0) Serial.println("‚úÖ POST Response: " + String(code));
      else Serial.println("‚ùå POST Error: " + http.errorToString(code));
      http.end();
    } else Serial.println("‚ùå WiFi not connected!");
  }

  delay(200);
}
