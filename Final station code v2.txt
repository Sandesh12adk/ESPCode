#include <SPI.h>
#include <LoRa.h>
#include <WiFi.h>
#include <HTTPClient.h>

/* -------- LoRa Pins -------- */
#define LORA_SCK  13
#define LORA_MISO 12
#define LORA_MOSI 27
#define LORA_SS   26
#define LORA_RST  25
#define LORA_DIO0 33

/* -------- SETTINGS -------- */
#define LORA_FREQ 433E6  // Frequency (433MHz, 866MHz, 915MHz)

/* -------- WIFI SETTINGS -------- */
const char* ssid = "HardwareHackathon203";
const char* password = "hardware";

/* -------- VARIABLES -------- */
String incomingData = "";

void setup() {
  Serial.begin(115200);
  delay(2000);
  Serial.println("\n=== ESP32 LORA THIRD STATION START ===");

  // ---- WIFI INIT ----
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ Connected to WiFi");
  Serial.print("ESP32 IP: ");
  Serial.println(WiFi.localIP());

  // ---- LORA INIT ----
  SPI.begin(LORA_SCK, LORA_MISO, LORA_MOSI, LORA_SS);
  LoRa.setPins(LORA_SS, LORA_RST, LORA_DIO0);

  if (!LoRa.begin(LORA_FREQ)) {
    Serial.println("‚ùå LoRa init failed!");
    while (1);
  }
  Serial.println("‚úÖ LoRa Ready (Third Station)");
}

void loop() {
  int packetSize = LoRa.parsePacket();
  if (packetSize) {
    incomingData = "";

    // Read LoRa packet
    while (LoRa.available()) {
      incomingData += (char)LoRa.read();
    }

    Serial.print("üì• Received: ");
    Serial.println(incomingData);

    // Parse CSV data: temp,humidity,pressure
    float temp = NAN, humidity = NAN, pressure = NAN;
    int firstComma = incomingData.indexOf(',');
    int secondComma = incomingData.indexOf(',', firstComma + 1);

    if (firstComma != -1 && secondComma != -1) {
      temp = incomingData.substring(0, firstComma).toFloat();
      humidity = incomingData.substring(firstComma + 1, secondComma).toFloat();
      pressure = incomingData.substring(secondComma + 1).toFloat();

      // Validate sensor ranges
      if (temp < -50 || temp > 60) temp = 0;
      if (humidity < 0 || humidity > 100) humidity = 0;
      if (pressure < 800 || pressure > 1200) pressure = 1013;
    } else {
      Serial.println("‚ùå Invalid LoRa data format!");
      return; // skip this packet
    }

    // Build JSON payload
    String jsonPayload = "{";
    jsonPayload += "\"temp\":" + String(temp, 1) + ",";
    jsonPayload += "\"humidity\":" + String(humidity, 1) + ",";
    jsonPayload += "\"pressure\":" + String(pressure, 1) + ",";
    jsonPayload += "\"uv\":0,";
    jsonPayload += "\"isRain\":false";
    jsonPayload += "}";

    Serial.print("üåê Sending JSON: ");
    Serial.println(jsonPayload);

    // Send POST request
    if (WiFi.status() == WL_CONNECTED) {
      HTTPClient http;
      http.begin("http://192.168.10.225:8080/weather-data"); // your server IP
      http.addHeader("Content-Type", "application/json");

      int httpResponseCode = http.POST(jsonPayload);

      if (httpResponseCode > 0) {
        Serial.print("‚úÖ POST Response: ");
        Serial.println(httpResponseCode);
      } else {
        Serial.print("‚ùå POST Error: ");
        Serial.println(http.errorToString(httpResponseCode));
      }

      http.end();
    } else {
      Serial.println("‚ùå WiFi not connected!");
    }
  }

  delay(200); // small delay to avoid flooding
}
